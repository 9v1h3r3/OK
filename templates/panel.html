<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Admin Panel</title>
  <script>
    async function stopUser(idx){
      await fetch('/stop/' + idx, {method: 'POST'});
      location.reload();
    }
    async function removeUser(idx){
      if(!confirm('Remove this user job?')) return;
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/remove/' + idx;
      document.body.appendChild(form);
      form.submit();
    }
    async function stopAll(){
      if(!confirm('Stop all jobs?')) return;
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/stop_all';
      document.body.appendChild(form);
      form.submit();
    }
    function copyToken(token) {
      navigator.clipboard.writeText(token).then(() => {
        alert("✅ Token copied to clipboard!");
      }).catch(err => {
        alert("❌ Failed to copy token: " + err);
      });
    }
  </script>
</head>
<body>
  <h2>Admin Panel</h2>
  <p><a href="/admin/logout">Logout</a></p>

  <h3>Active Jobs</h3>
  <button onclick="stopAll()">Stop All</button>
  <table border="1" cellpadding="6" cellspacing="0">
    <thead>
      <tr>
        <th>#</th>
        <th>Tokens</th>
        <th>Thread ID</th>
        <th>Prefix</th>
        <th>Interval (s)</th>
        <th>Messages</th>
        <th>Running</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td>{{ u.idx }}</td>
        <td>
          {% for t in u.masked_tokens %}
            <div>
              {{ t }}
              <button type="button" onclick="copyToken('{{ u.tokens[loop.index0] }}')">
                Copy
              </button>
            </div>
          {% endfor %}
        </td>
        <td>{{ u.thread_id }}</td>
        <td>{{ u.prefix }}</td>
        <td>{{ u.interval }}</td>
        <td>{{ u.message_count }}</td>
        <td>{{ 'Yes' if u.is_running else 'No' }}</td>
        <td>
          <button onclick="stopUser({{ u.idx }})">Stop</button>
          <button onclick="removeUser({{ u.idx }})">Remove</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <h3>Logs</h3>
  <div style="background:#f4f4f4;padding:10px;max-height:400px;overflow:auto;">
    {{ logs | safe }}
  </div>
</body>
</html>
